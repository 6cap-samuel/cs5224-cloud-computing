<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#2563eb">
  <title>VapeWatch Submission</title>
  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <style>
    :root {
      --page-bg: linear-gradient(135deg, #eff6ff 0%, #e2e8f0 40%, #f8fafc 100%);
      --card-bg: #ffffff;
      --text-color: #0f172a;
      --muted: #64748b;
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --border: #dce5f4;
      --success: #047857;
      --error: #b91c1c;
      --pending: #b45309;
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
    }

    body {
      margin: 0;
      font-family: "Inter", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      background: var(--page-bg);
      color: var(--text-color);
    }

    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .page {
      min-height: 100%;
      display: flex;
      flex-direction: column;
    }

    .top-bar {
      display: flex;
      justify-content: center;
      padding: 1.75rem;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 0.9rem;
      background: rgba(15, 23, 42, 0.7);
      color: #e2e8f0;
      padding: 0.75rem 1.25rem;
      border-radius: 999px;
      box-shadow: 0 12px 28px rgba(15, 23, 42, 0.25);
    }

    .brand-mark {
      background: rgba(37, 99, 235, 0.18);
      color: #bfdbfe;
      font-weight: 700;
      padding: 0.4rem 0.6rem;
      border-radius: 999px;
      letter-spacing: 0.08em;
      font-size: 0.75rem;
      text-transform: uppercase;
    }

    .brand-title {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
      letter-spacing: 0.01em;
    }

    .brand-subtitle {
      margin: 0;
      font-size: 0.78rem;
      opacity: 0.85;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .content {
      flex: 1;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 2rem 1rem 3rem;
    }

    .card {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 2.75rem 2.5rem;
      max-width: 560px;
      width: 100%;
      box-shadow: 0 36px 70px rgba(15, 23, 42, 0.18);
      border: 1px solid rgba(148, 163, 184, 0.14);
    }

    h1 {
      margin: 0 0 0.85rem;
      font-size: 2.1rem;
      letter-spacing: -0.02em;
    }

    .leading {
      margin: 0 0 2.2rem;
      color: var(--muted);
      font-size: 1rem;
      line-height: 1.6;
    }

    .stack {
      display: flex;
      flex-direction: column;
      gap: 1.75rem;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .field-label {
      font-weight: 600;
      font-size: 0.95rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #1e293b;
    }

    .field-hint {
      margin: 0;
      color: var(--muted);
      font-size: 0.85rem;
      line-height: 1.5;
    }

    .file-input {
      padding: 1.1rem;
      border-radius: 14px;
      border: 1px dashed #94a3b8;
      background: #f8fafc;
      font-size: 0.95rem;
      transition: border-color 0.2s ease, background-color 0.2s ease, box-shadow 0.2s ease;
      cursor: pointer;
      color: #1e293b;
    }

    .file-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.15);
      background: #ffffff;
    }

    .file-input:hover {
      border-color: var(--primary);
      background: #ffffff;
    }

    .file-input::file-selector-button {
      background: var(--primary-dark);
      color: #ffffff;
      border: none;
      padding: 0.65rem 1.2rem;
      border-radius: 10px;
      margin-right: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .file-input::file-selector-button:hover {
      background: var(--primary);
      transform: translateY(-1px);
    }

    .file-input::-webkit-file-upload-button {
      background: var(--primary-dark);
      color: #ffffff;
      border: none;
      padding: 0.65rem 1.2rem;
      border-radius: 10px;
      margin-right: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .file-input::-webkit-file-upload-button:hover {
      background: var(--primary);
      transform: translateY(-1px);
    }

    .file-meta {
      margin: 0;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .file-meta[data-state="ready"] {
      color: #1e293b;
      font-weight: 600;
    }

    .location-card {
      border: 1px solid rgba(148, 163, 184, 0.28);
      background: #f8fafc;
      border-radius: 18px;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }

    .location-header {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .location-status {
      font-size: 0.9rem;
      color: var(--muted);
      padding: 0.75rem 1rem;
      border-radius: 12px;
      background: #ffffff;
      border: 1px solid rgba(148, 163, 184, 0.2);
      transition: color 0.2s ease, border-color 0.2s ease, background 0.2s ease;
    }

    .location-status[data-state="attached"] {
      color: var(--success);
      border-color: rgba(22, 163, 74, 0.35);
      background: #ecfdf3;
    }

    .location-status[data-state="error"] {
      color: var(--error);
      border-color: rgba(239, 68, 68, 0.3);
      background: #fef2f2;
    }

    .location-info {
      font-size: 0.78rem;
      color: var(--muted);
    }

    .location-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .location-map-wrapper {
      position: relative;
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.28);
      background: linear-gradient(145deg, #e2e8f0, #f8fafc);
      height: 240px;
    }

    .location-map {
      position: absolute;
      inset: 0;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 1;
    }

    .location-map[data-visible="true"] {
      opacity: 1;
    }

    .location-map-placeholder {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-size: 0.9rem;
      color: var(--muted);
      padding: 1.5rem;
      z-index: 2;
      backdrop-filter: blur(1px);
      transition: opacity 0.2s ease;
    }

    .location-map-placeholder[data-hidden="true"] {
      opacity: 0;
      pointer-events: none;
    }

    .ghost-button {
      background: rgba(37, 99, 235, 0.08);
      border: 1px solid rgba(37, 99, 235, 0.2);
      color: var(--primary);
      padding: 0.65rem 1.1rem;
      border-radius: 999px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease, border-color 0.2s ease, color 0.2s ease, transform 0.2s ease;
    }

    .ghost-button:hover:not(:disabled) {
      background: rgba(37, 99, 235, 0.14);
      border-color: rgba(37, 99, 235, 0.38);
      transform: translateY(-1px);
    }

    .ghost-button:disabled {
      cursor: not-allowed;
      opacity: 0.6;
      background: rgba(148, 163, 184, 0.2);
      border-color: rgba(148, 163, 184, 0.25);
      color: rgba(100, 116, 139, 0.85);
      transform: none;
    }

    textarea {
      min-height: 140px;
      padding: 1.1rem;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: #f8fafc;
      font-size: 0.95rem;
      resize: vertical;
      transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
      color: #0f172a;
    }

    textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.12);
      background: #ffffff;
    }

    button {
      margin-top: 0.5rem;
      padding: 1rem 1.25rem;
      border: none;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: #ffffff;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
    }

    button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 18px 36px rgba(37, 99, 235, 0.28);
    }

    button:disabled {
      cursor: wait;
      background: linear-gradient(135deg, #93c5fd, #60a5fa);
      box-shadow: none;
      opacity: 0.85;
    }

    .preview {
      display: flex;
      justify-content: center;
      align-items: center;
      background: #f1f5f9;
      border-radius: 16px;
      padding: 1.5rem;
      border: 1px solid rgba(148, 163, 184, 0.35);
      min-height: 140px;
      overflow: hidden;
      text-align: center;
    }

    .preview img {
      max-width: 100%;
      border-radius: 12px;
      box-shadow: 0 16px 34px rgba(15, 23, 42, 0.18);
    }

    .preview-placeholder {
      color: var(--muted);
      font-size: 0.9rem;
    }

    .status {
      font-size: 0.95rem;
      min-height: 1.2rem;
      padding: 0.75rem 1rem;
      border-radius: 12px;
      background: #f8fafc;
      border: 1px solid transparent;
      color: var(--muted);
      transition: border-color 0.2s ease, background 0.2s ease, color 0.2s ease;
    }

    .status:not(:empty) {
      border-color: rgba(148, 163, 184, 0.35);
    }

    .status--success {
      background: #ecfdf3;
      border-color: rgba(22, 163, 74, 0.4);
      color: var(--success);
    }

    .status--error {
      background: #fef2f2;
      border-color: rgba(239, 68, 68, 0.4);
      color: var(--error);
    }

    .status--pending {
      background: #fffbeb;
      border-color: rgba(217, 119, 6, 0.4);
      color: var(--pending);
    }

    .page-footer {
      text-align: center;
      padding: 1.75rem;
      font-size: 0.85rem;
      color: var(--muted);
    }

    @media (max-width: 640px) {
      .card {
        padding: 2.35rem 1.75rem;
        border-radius: 18px;
      }

      .top-bar {
        padding: 1.25rem;
      }

      .brand {
        padding: 0.6rem 1rem;
      }

      h1 {
        font-size: 1.8rem;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="top-bar">
      <div class="brand">
        <span class="brand-mark">VW</span>
        <div>
          <p class="brand-title">VapeWatch</p>
          <p class="brand-subtitle">Incident Intake Portal</p>
        </div>
      </div>
    </header>
    <main class="content">
      <section class="card form-card">
        <h1>Submit Evidence For Review</h1>
        <p class="leading">Provide a clear photo and supporting context so our enforcement team can respond quickly and effectively.</p>
        <form id="report-form" class="stack" novalidate>
          <div class="field">
            <label class="field-label" for="photo">Evidence photo</label>
            <p class="field-hint">JPEG or PNG, up to 10 MB. A well-lit, close-up image helps us classify the report.</p>
            <input id="photo" name="photo" type="file" accept="image/*" required class="file-input">
            <p class="file-meta" data-state="empty" data-file-name>No file selected yet.</p>
          </div>
          <div class="preview" id="preview" aria-live="polite" aria-atomic="true"></div>
          <section class="location-card" aria-labelledby="location-label">
            <div class="location-header">
              <p id="location-label" class="field-label">Location (optional)</p>
              <p class="field-hint">Attach the device coordinates to help staff pinpoint where the evidence was found.</p>
            </div>
            <div class="location-status" id="location-status" role="status">No location attached yet.</div>
            <div class="location-actions">
              <button type="button" class="ghost-button" id="location-capture">Use current location</button>
              <button type="button" class="ghost-button" id="location-clear" disabled>Remove location</button>
            </div>
            <p class="location-info">Location requests rely on browser permissions and may be less precise indoors.</p>
            <div class="location-map-wrapper">
              <div id="location-map" class="location-map" aria-hidden="true"></div>
              <div id="location-map-placeholder" class="location-map-placeholder">Attach location to preview it on the map.</div>
            </div>
          </section>
          <div class="field">
            <label class="field-label" for="notes">Supporting notes</label>
            <p class="field-hint">Include the location, time, and any other details that help validate the evidence.</p>
            <textarea id="notes" name="notes" placeholder="Example: Found in the east stairwell during 3rd period. Strong smell of mint in the area."></textarea>
          </div>
          <button id="submit-btn" type="submit">Submit Report</button>
          <div class="status" id="status" role="alert"></div>
        </form>
      </section>
  </main>
  <footer class="page-footer">
    <p>VapeWatch keeps campuses safe by surfacing incidents to designated staff in real time.</p>
  </footer>
</div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    const API_BASE_URL = "${api_base_url}";

    const form = document.getElementById('report-form');
    const statusEl = document.getElementById('status');
    const submitBtn = document.getElementById('submit-btn');
    const preview = document.getElementById('preview');
    const photoInput = document.getElementById('photo');
    const fileMeta = document.querySelector('[data-file-name]');
    const notesInput = document.getElementById('notes');
    const locationStatus = document.getElementById('location-status');
    const locationCapture = document.getElementById('location-capture');
    const locationClear = document.getElementById('location-clear');
    const locationMap = document.getElementById('location-map');
    const locationMapPlaceholder = document.getElementById('location-map-placeholder');

    let previewUrl;
    const locationState = {
      latitude: null,
      longitude: null,
      accuracy: null,
      captured_at: null
    };
    let mapInstance;
    let mapMarker;
    let mapAccuracyCircle;

    const formatBytes = (bytes) => {
      if (!bytes) {
        return '0 B';
      }
      const units = ['B', 'KB', 'MB', 'GB'];
      let value = bytes;
      let index = 0;
      while (value >= 1024 && index < units.length - 1) {
        value /= 1024;
        index += 1;
      }
      const precision = value >= 10 || index === 0 ? 0 : 1;
      return value.toFixed(precision) + ' ' + units[index];
    };

    const setStatus = (message, variant = '') => {
      statusEl.textContent = message;
      statusEl.className = variant ? 'status status--' + variant : 'status';
    };

    const resetLocationState = () => {
      locationState.latitude = null;
      locationState.longitude = null;
      locationState.accuracy = null;
      locationState.captured_at = null;
      locationStatus.textContent = 'No location attached yet.';
      locationStatus.dataset.state = '';
      locationStatus.classList.remove('visually-hidden');
      locationClear.disabled = true;
      resetLocationMap();
    };

    const updateLocationAttached = () => {
      if (locationState.latitude === null || locationState.longitude === null) {
        return resetLocationState();
      }
      let message = 'Location attached. Map preview updated below.';
      if (typeof locationState.accuracy === 'number') {
        const rounded = Math.round(locationState.accuracy);
        message += ' Accuracy about ±' + rounded + ' m.';
      }
      locationStatus.textContent = message;
      locationStatus.dataset.state = 'attached';
      locationStatus.classList.add('visually-hidden');
      locationClear.disabled = false;
      renderLocationMap();
    };

    const useGeolocation = () => {
      if (!navigator.geolocation) {
        locationStatus.classList.remove('visually-hidden');
        locationStatus.textContent = 'This browser does not support location services.';
        locationStatus.dataset.state = 'error';
        locationCapture.disabled = true;
        return;
      }

      locationStatus.classList.remove('visually-hidden');
      locationStatus.textContent = 'Requesting device location...';
      locationStatus.dataset.state = '';
      locationCapture.disabled = true;

      navigator.geolocation.getCurrentPosition(
        (position) => {
          const coords = position.coords;
          const lat = Number(coords.latitude.toFixed(6));
          const lon = Number(coords.longitude.toFixed(6));
          if (isNaN(lat) || isNaN(lon)) {
            locationStatus.classList.remove('visually-hidden');
            locationStatus.textContent = 'Received invalid coordinates from the device.';
            locationStatus.dataset.state = 'error';
            locationCapture.disabled = false;
            return;
          }
          locationState.latitude = lat;
          locationState.longitude = lon;
          locationState.accuracy = typeof coords.accuracy === 'number' ? coords.accuracy : null;
          locationState.captured_at = position.timestamp ? new Date(position.timestamp).toISOString() : new Date().toISOString();
          updateLocationAttached();
          locationCapture.disabled = false;
        },
        (error) => {
          let message = 'Unable to obtain location.';
          if (error && error.code === error.PERMISSION_DENIED) {
            message = 'Location permission was denied.';
          } else if (error && error.code === error.POSITION_UNAVAILABLE) {
            message = 'Location information is unavailable right now.';
          } else if (error && error.code === error.TIMEOUT) {
            message = 'Location request timed out. Try again.';
          }
          locationStatus.classList.remove('visually-hidden');
          locationStatus.textContent = message;
          locationStatus.dataset.state = 'error';
          locationCapture.disabled = false;
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
    };

    locationCapture.addEventListener('click', useGeolocation);
    locationClear.addEventListener('click', () => {
      resetLocationState();
    });

    function resetLocationMap() {
      if (locationMapPlaceholder) {
        locationMapPlaceholder.textContent = 'Attach location to preview it on the map.';
        locationMapPlaceholder.dataset.hidden = '';
      }
      if (locationMap) {
        locationMap.dataset.visible = '';
      }
      if (mapMarker && mapInstance) {
        mapInstance.removeLayer(mapMarker);
      }
      if (mapAccuracyCircle && mapInstance) {
        mapInstance.removeLayer(mapAccuracyCircle);
      }
      mapMarker = null;
      mapAccuracyCircle = null;
    }

    function ensureMapInstance() {
      if (!locationMap || !window.L) {
        return null;
      }
      if (!mapInstance) {
        mapInstance = L.map(locationMap, {
          zoomControl: true,
          attributionControl: false,
          worldCopyJump: true
        });
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          tileSize: 256
        }).addTo(mapInstance);
      }
      return mapInstance;
    }

    function renderLocationMap() {
      if (!locationMap || locationState.latitude === null || locationState.longitude === null) {
        return resetLocationMap();
      }
      const map = ensureMapInstance();
      if (!map) {
        if (locationMapPlaceholder) {
          locationMapPlaceholder.textContent = 'Location attached, but the map could not load.';
          locationMapPlaceholder.dataset.hidden = '';
        }
        return;
      }
      const lat = locationState.latitude;
      const lon = locationState.longitude;
      const latLng = [lat, lon];
      if (!mapMarker) {
        mapMarker = L.marker(latLng).addTo(map);
      } else {
        mapMarker.setLatLng(latLng);
      }
      if (typeof locationState.accuracy === 'number' && locationState.accuracy > 0) {
        if (!mapAccuracyCircle) {
          mapAccuracyCircle = L.circle(latLng, {
            radius: locationState.accuracy,
            color: '#2563eb',
            weight: 1,
            fillColor: '#2563eb',
            fillOpacity: 0.12
          }).addTo(map);
        } else {
          mapAccuracyCircle.setLatLng(latLng);
          mapAccuracyCircle.setRadius(locationState.accuracy);
        }
      } else if (mapAccuracyCircle) {
        map.removeLayer(mapAccuracyCircle);
        mapAccuracyCircle = null;
      }
      map.setView(latLng, 17);
      if (locationMapPlaceholder) {
        locationMapPlaceholder.textContent = '';
        locationMapPlaceholder.dataset.hidden = 'true';
      }
      if (locationMap) {
        locationMap.dataset.visible = 'true';
      }
      setTimeout(() => {
        map.invalidateSize();
      }, 50);
    }

    const clearPreview = () => {
      if (previewUrl) {
        URL.revokeObjectURL(previewUrl);
        previewUrl = null;
      }
      preview.innerHTML = '';
    };

    const updatePreview = (file) => {
      clearPreview();
      if (!file) {
        preview.innerHTML = '<span class="preview-placeholder">Attach a photo to see a live preview here.</span>';
        fileMeta.textContent = 'No file selected yet.';
        fileMeta.dataset.state = 'empty';
        return;
      }

      previewUrl = URL.createObjectURL(file);
      const img = document.createElement('img');
      img.src = previewUrl;
      img.alt = 'Selected photo preview';
      preview.appendChild(img);

      fileMeta.textContent = file.name + ' · ' + formatBytes(file.size);
      fileMeta.dataset.state = 'ready';
    };

    photoInput.addEventListener('change', () => {
      const file = photoInput.files[0];
      updatePreview(file);
    });

    updatePreview(null);
    resetLocationState();

    form.addEventListener('submit', (event) => {
      event.preventDefault();
      const file = photoInput.files[0];
      if (!file) {
        setStatus('Please attach an evidence photo before submitting.', 'error');
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'Uploading...';
      setStatus('Uploading evidence...', 'pending');

      const reader = new FileReader();
      reader.onload = async () => {
        try {
          const base64 = reader.result.split(',')[1];
          const payload = {
            filename: file.name,
            content_type: file.type,
            photo_base64: base64,
            notes: notesInput.value || ''
          };
          if (locationState.latitude !== null && locationState.longitude !== null) {
            payload.location = {
              latitude: locationState.latitude,
              longitude: locationState.longitude
            };
            if (typeof locationState.accuracy === 'number') {
              payload.location.accuracy_m = locationState.accuracy;
            }
            if (locationState.captured_at) {
              payload.location.captured_at = locationState.captured_at;
            }
          }

          const response = await fetch(API_BASE_URL + '/reports', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            throw new Error('Request failed with ' + response.status);
          }

          setStatus('Thanks! Your report was submitted for processing.', 'success');
          form.reset();
          updatePreview(null);
          resetLocationState();
        } catch (error) {
          console.error(error);
          setStatus('Unable to submit right now. Please try again shortly.', 'error');
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit Report';
        }
      };

      reader.onerror = () => {
        setStatus('Could not read that file. Try a different photo.', 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Report';
      };

      reader.readAsDataURL(file);
    });

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker
          .register('/service-worker.js')
          .catch((error) => {
            console.error('Service worker registration failed:', error);
          });
      });
    }
  </script>
</body>
</html>
