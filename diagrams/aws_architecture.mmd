flowchart LR
  citizen["ğŸ‘¤ Citizen Browser"]
  officer["ğŸ›¡ï¸ Officer Browser"]

  subgraph CitizenPortal["Citizen Submission Portal\n(ap-southeast-1)"]
    s3citizen["ğŸ—‚ï¸ S3 Static Website"]
    cfCitizen["ğŸŒ CloudFront Distribution"]
    citizen --> cfCitizen --> s3citizen
  end

  subgraph OfficerPortal["Officer Admin Portal\n(ap-southeast-1)"]
    s3officer["ğŸ—‚ï¸ S3 Static Website"]
    cfOfficer["ğŸŒ CloudFront Distribution"]
    officer --> cfOfficer --> s3officer
  end

  apigw["ğŸ§­ API Gateway HTTP API\nRegion: ap-southeast-1"]
  cfCitizen --> apigw
  cfOfficer --> apigw

  ingest["Î» Lambda: ingest"]
  officerLambda["Î» Lambda: officer_admin"]
  apigw -->|POST /reports| ingest
  apigw -->|"GET /reports,<br/>POST /reports/{id}/audit,<br/>GET /reports/{id}/history"| officerLambda

  sfn["ğŸ” Step Functions Pipeline"]
  ingest -->|StartExecution| sfn

  redaction["Î» Lambda: redaction"]
  inference["Î» Lambda: inference"]
  enrichment["Î» Lambda: enrichment"]
  persist["Î» Lambda: persist"]
  sfn --> redaction --> inference --> enrichment --> persist

  sagemaker["ğŸ§  SageMaker Endpoint (YOLOv8)\n(ap-southeast-1)"]
  inference -->|Invoke| sagemaker

  raw["ğŸª£ S3 Raw Bucket\n(ap-southeast-1)"]
  evidence["ğŸª£ S3 Evidence Bucket\n(ap-southeast-1)"]
  auditS3["ğŸª£ S3 Audit Log (Object Lock)\n(ap-southeast-1)"]
  datasets["ğŸ—‚ï¸ S3 Ref Data (lampposts/parks)<br/>(data.gov.sg)"]
  ingest --> raw
  redaction --> raw
  raw --> evidence
  ingest --> datasets
  inference --> raw

  weatherApi["ğŸŒ¦ï¸ data.gov.sg Weather API"]
  ingest -->|"2-hour forecast"| weatherApi

  ddb["ğŸ“š DynamoDB Reports Table\n(ap-southeast-1)"]
  persist --> ddb
  officerLambda -->|query & update audit/audit_history| ddb

  auditLambda["Î» Lambda: audit_sink"]
  ddb -->|Stream| auditLambda --> auditS3

  sns["ğŸ“£ SNS Officer Alerts"]
  persist --> sns

  cognito["ğŸ” Amazon Cognito User Pool\n(ap-southeast-1)"]
  officer --> cognito --> officerLambda

  officerLambda --> raw
  officerLambda --> evidence
